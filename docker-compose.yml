version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: nudge
    ports:
      - "5432:5432"
    volumes:
      - nudge_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d nudge"]
      interval: 5s
      timeout: 5s
      retries: 10

  api:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - .:/app
    environment:
      # Required by app/settings.py at import time
      DATABASE_URL: postgresql+psycopg://postgres:postgres@db:5432/nudge?sslmode=disable

      # Optional: your settings.py already defaults this, but leaving it explicit is fine
      DEV_USER_ID: 00000000-0000-0000-0000-000000000001
       # -------------------------
      # LLM tier registry (no secrets committed)
      # Use your local .env to provide these values.
      # docker compose automatically loads .env for variable substitution.
      # -------------------------
      LLM_DEFAULT_MODEL_KEY: ${LLM_DEFAULT_MODEL_KEY:-mid}

      LLM_STRONG_PROVIDER: ${LLM_STRONG_PROVIDER:-placeholder}
      LLM_STRONG_MODEL: ${LLM_STRONG_MODEL:-placeholder}
      LLM_STRONG_BASE_URL: ${LLM_STRONG_BASE_URL:-}
      LLM_STRONG_API_KEY: ${LLM_STRONG_API_KEY:-}

      LLM_MID_PROVIDER: ${LLM_MID_PROVIDER:-placeholder}
      LLM_MID_MODEL: ${LLM_MID_MODEL:-placeholder}
      LLM_MID_BASE_URL: ${LLM_MID_BASE_URL:-}
      LLM_MID_API_KEY: ${LLM_MID_API_KEY:-}

      LLM_BUDGET_PROVIDER: ${LLM_BUDGET_PROVIDER:-placeholder}
      LLM_BUDGET_MODEL: ${LLM_BUDGET_MODEL:-placeholder}
      LLM_BUDGET_BASE_URL: ${LLM_BUDGET_BASE_URL:-}
      LLM_BUDGET_API_KEY: ${LLM_BUDGET_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    command: >
      sh -lc "
        pip install --no-cache-dir -r Requirements.txt &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      "

  worker:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - .:/app
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:postgres@db:5432/nudge?sslmode=disable
      DEV_USER_ID: 00000000-0000-0000-0000-000000000001

        # LLM registry (same as API service)
      LLM_DEFAULT_MODEL_KEY: ${LLM_DEFAULT_MODEL_KEY:-mid}

      LLM_STRONG_PROVIDER: ${LLM_STRONG_PROVIDER:-placeholder}
      LLM_STRONG_MODEL: ${LLM_STRONG_MODEL:-placeholder}
      LLM_STRONG_BASE_URL: ${LLM_STRONG_BASE_URL:-}
      LLM_STRONG_API_KEY: ${LLM_STRONG_API_KEY:-}

      LLM_MID_PROVIDER: ${LLM_MID_PROVIDER:-placeholder}
      LLM_MID_MODEL: ${LLM_MID_MODEL:-placeholder}
      LLM_MID_BASE_URL: ${LLM_MID_BASE_URL:-}
      LLM_MID_API_KEY: ${LLM_MID_API_KEY:-}

      LLM_BUDGET_PROVIDER: ${LLM_BUDGET_PROVIDER:-placeholder}
      LLM_BUDGET_MODEL: ${LLM_BUDGET_MODEL:-placeholder}
      LLM_BUDGET_BASE_URL: ${LLM_BUDGET_BASE_URL:-}
      LLM_BUDGET_API_KEY: ${LLM_BUDGET_API_KEY:-}

      #Optional tuning (safe defaults already exist)
      WORKER_POLL_SECONDS: 3
      WORKER_BATCH_SIZE: 5
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -lc "
        pip install --no-cache-dir -r Requirements.txt &&
        python -m app.worker
      "  
  
  # Run with: docker compose run --rm migrate
  # Optional one-shot migration runner:
  migrate:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - .:/app
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:postgres@db:5432/nudge?sslmode=disable
      DEV_USER_ID: 00000000-0000-0000-0000-000000000001
    depends_on:
      db:
        condition: service_healthy
    command: >
      sh -lc "
        pip install --no-cache-dir -r Requirements.txt &&
        alembic upgrade head
      "
    profiles: ["tools"]

volumes:
  nudge_pgdata:
